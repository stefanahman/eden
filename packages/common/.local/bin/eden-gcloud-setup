#!/usr/bin/env bash
# eden-gcloud-setup - Install Google Cloud CLI using official method
# This script downloads and installs gcloud from Google's official source

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
RESET='\033[0m'

print_header() {
    echo -e "${BOLD}${BLUE}$1${RESET}"
}

print_success() {
    echo -e "${GREEN}✓${RESET} $1"
}

print_error() {
    echo -e "${RED}✗${RESET} $1" >&2
}

print_info() {
    echo -e "${BLUE}→${RESET} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${RESET} $1"
}

# Check if gcloud is already installed
if command -v gcloud &> /dev/null; then
    print_warning "gcloud is already installed!"
    echo ""
    gcloud version
    echo ""
    read -p "Do you want to reinstall/update? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_info "Exiting without changes"
        exit 0
    fi
fi

print_header "Google Cloud CLI Setup"
echo ""
print_info "This will install gcloud using Google's official installation method"
echo ""

# Installation directory
INSTALL_DIR="${HOME}/.local/share/google-cloud-sdk"
TEMP_DIR="/tmp/gcloud-install-$$"

# Create temp directory
mkdir -p "$TEMP_DIR"
cd "$TEMP_DIR"

# Detect architecture
ARCH=$(uname -m)
case "$ARCH" in
    x86_64)
        ARCH_NAME="x86_64"
        ;;
    aarch64|arm64)
        ARCH_NAME="arm"
        ;;
    *)
        print_error "Unsupported architecture: $ARCH"
        exit 1
        ;;
esac

# Download URL
DOWNLOAD_URL="https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-linux-${ARCH_NAME}.tar.gz"

print_info "Downloading Google Cloud CLI..."
print_info "URL: $DOWNLOAD_URL"

if ! curl -L -o gcloud-cli.tar.gz "$DOWNLOAD_URL"; then
    print_error "Failed to download Google Cloud CLI"
    rm -rf "$TEMP_DIR"
    exit 1
fi

print_success "Downloaded successfully"
echo ""

print_info "Extracting archive..."
tar -xzf gcloud-cli.tar.gz

print_success "Extracted successfully"
echo ""

# Remove old installation if exists
if [ -d "$INSTALL_DIR" ]; then
    print_info "Removing old installation at $INSTALL_DIR..."
    rm -rf "$INSTALL_DIR"
fi

# Move to final location
print_info "Installing to $INSTALL_DIR..."
mkdir -p "$(dirname "$INSTALL_DIR")"
mv google-cloud-sdk "$INSTALL_DIR"

# Detect shell and set appropriate rc file
SHELL_NAME=$(basename "$SHELL")
case "$SHELL_NAME" in
    zsh)
        RC_FILE="$HOME/.zshrc"
        ;;
    bash)
        RC_FILE="$HOME/.bashrc"
        ;;
    fish)
        RC_FILE="$HOME/.config/fish/config.fish"
        ;;
    *)
        RC_FILE="$HOME/.bashrc"
        print_warning "Unknown shell: $SHELL_NAME, defaulting to .bashrc"
        ;;
esac

# Run the installer
print_info "Running Google Cloud SDK installer..."
print_info "Configuring for shell: $SHELL_NAME ($RC_FILE)"
echo ""
"$INSTALL_DIR/install.sh" \
    --usage-reporting=false \
    --command-completion=true \
    --path-update=true \
    --rc-path="$RC_FILE" \
    --quiet

print_success "Installation complete!"
echo ""

# Clean up
rm -rf "$TEMP_DIR"

# Add to PATH for current session
if [[ ":$PATH:" != *":$INSTALL_DIR/bin:"* ]]; then
    export PATH="$INSTALL_DIR/bin:$PATH"
fi

print_header "Setup Complete!"
echo ""
print_info "Google Cloud CLI has been installed to: $INSTALL_DIR"
echo ""
print_info "Next steps:"
echo "  1. Restart your shell or run: source ~/.zshenv"
echo "  2. Initialize gcloud: gcloud init"
echo "  3. Authenticate: gcloud auth login"
echo ""
print_success "Verify installation:"
gcloud version

