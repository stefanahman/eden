#!/bin/bash
# graft-git - Integrate git identities from branches
# Part of Eden's pluggable grafter system
#
# Branches provide identities at .config/git/identities/<name>
# This grafter symlinks them and generates includeIf directives
set -e

# Detect Eden root from script location
if [[ -z "$EDEN_ROOT" ]]; then
    SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")"
    EDEN_ROOT="$(cd "$(dirname "$SCRIPT_PATH")/../../../../.." && pwd)"
fi

BRANCHES_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/eden/branches"

if [[ ! -f "$BRANCHES_FILE" ]]; then
    echo "  → No branches registered (skipping)"
    exit 0
fi

# Expand variables in branch path
expand_branch_path() {
    local path="$1"
    path="${path//\$EDEN_ROOT/$EDEN_ROOT}"
    path="${path/#\~/$HOME}"
    echo "$path"
}

IDENTITIES_DIR="$HOME/.config/git/identities"
GITCONFIG_LOCAL="${XDG_CONFIG_HOME:-$HOME/.config}/eden/local/gitconfig"

added=0
skipped=0

# Ensure directories exist
mkdir -p "$IDENTITIES_DIR"
mkdir -p "$(dirname "$GITCONFIG_LOCAL")"

# Create local gitconfig if it doesn't exist
if [[ ! -f "$GITCONFIG_LOCAL" ]]; then
    cat > "$GITCONFIG_LOCAL" << 'EOF'
# Local git configuration - auto-generated by 'eden graft'
# Contains includeIf directives for git identities from branches
EOF
    echo "  → Created $GITCONFIG_LOCAL"
fi

while IFS= read -r branch_path || [[ -n "$branch_path" ]]; do
    [[ -z "$branch_path" || "$branch_path" =~ ^[[:space:]]*# ]] && continue

    branch_path=$(expand_branch_path "$branch_path")
    [[ -d "$branch_path" ]] || continue

    branch_name=$(basename "$branch_path")
    source_dir="$branch_path/.config/git/identities"
    [[ -d "$source_dir" ]] || continue

    for identity_file in "$source_dir"/*; do
        [[ -e "$identity_file" ]] || continue
        [[ -f "$identity_file" ]] || continue

        name=$(basename "$identity_file")
        target="$IDENTITIES_DIR/$name"

        # Symlink the identity file
        if [[ -L "$target" ]]; then
            current=$(readlink "$target")
            if [[ "$current" == "$identity_file" ]]; then
                echo "  ✓ identity/$name ($branch_name) [already linked]"
            else
                echo "  ⚠ identity/$name: conflict ($branch_name vs existing)"
                continue
            fi
        else
            ln -sf "$identity_file" "$target"
            echo "  → identity/$name ($branch_name)"
        fi

        # Add includeIf if not already present
        if ! grep -q "identities/$name" "$GITCONFIG_LOCAL" 2>/dev/null; then
            cat >> "$GITCONFIG_LOCAL" << EOF

# $name identity (from $branch_name branch)
[includeIf "gitdir:~/Development/$name/"]
	path = ~/.config/git/identities/$name
EOF
            added=$((added + 1))
        else
            skipped=$((skipped + 1))
        fi
    done
done < "$BRANCHES_FILE"

if [[ $added -gt 0 ]]; then
    echo "  → Grafted $added git identity(ies)"
fi
[[ $skipped -gt 0 ]] && echo "  → Skipped $skipped already grafted"

if [[ $added -eq 0 && $skipped -eq 0 ]]; then
    echo "  → No git identities found in branches"
fi

exit 0
