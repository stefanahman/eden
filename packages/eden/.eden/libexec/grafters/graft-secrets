#!/bin/bash
# graft-secrets - Aggregate .eden-secrets from trunk and branches
# Part of Eden's pluggable grafter system
set -e

# Detect Eden root from script location
if [[ -z "$EDEN_ROOT" ]]; then
    SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")"
    EDEN_ROOT="$(cd "$(dirname "$SCRIPT_PATH")/../../../../.." && pwd)"
fi

# Expand variables in branch path
expand_branch_path() {
    local path="$1"
    # Expand $EDEN_ROOT
    path="${path//\$EDEN_ROOT/$EDEN_ROOT}"
    # Expand tilde
    path="${path/#\~/$HOME}"
    echo "$path"
}

BRANCHES_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/eden/branches"
OUTPUT_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/eden/local/secrets-all"

# Ensure output directory exists
mkdir -p "$(dirname "$OUTPUT_FILE")"

# Start with header
cat > "$OUTPUT_FILE" << 'EOF'
# Eden Secrets Registry (GENERATED - DO NOT EDIT)
# 
# This file is automatically generated by 'eden graft'
# It aggregates all .eden-secrets from trunk and branches
#
# To add secrets, edit .eden-secrets in your branches, then run 'eden graft'
# 
# Commands:
#   eden-secrets list      - Show all required secrets
#   eden-secrets validate  - Check if secrets exist in 1Password

EOF

secrets_count=0

# Add trunk secrets if they exist
TRUNK_SECRETS="$EDEN_ROOT/.eden-secrets"
if [[ -f "$TRUNK_SECRETS" ]]; then
    # Check if file has any [secret] sections
    if grep -q "^\[secret\]" "$TRUNK_SECRETS" 2>/dev/null; then
        echo "" >> "$OUTPUT_FILE"
        echo "# ===== Source: Eden (trunk) =====" >> "$OUTPUT_FILE"
        # Skip header comments, only copy [secret] sections and their content
        grep -v "^#" "$TRUNK_SECRETS" | grep -v "^[[:space:]]*$" >> "$OUTPUT_FILE" || true
        count=$(grep -c "^\[secret\]" "$TRUNK_SECRETS" 2>/dev/null || echo 0)
        secrets_count=$((secrets_count + count))
    fi
fi

# Add branch secrets if branches file exists
if [[ -f "$BRANCHES_FILE" ]]; then
    while IFS= read -r branch_path; do
        [[ -z "$branch_path" ]] && continue
        [[ "$branch_path" =~ ^[[:space:]]*# ]] && continue
        
        # Expand variables and tilde
        branch_path=$(expand_branch_path "$branch_path")
        
        branch_name=$(basename "$branch_path")
        branch_secrets="$branch_path/.eden-secrets"
        
        if [[ -f "$branch_secrets" ]]; then
            # Check if file has any [secret] sections
            if grep -q "^\[secret\]" "$branch_secrets" 2>/dev/null; then
                echo "" >> "$OUTPUT_FILE"
                echo "# ===== Source: $branch_name =====" >> "$OUTPUT_FILE"
                # Skip header comments, only copy [secret] sections and their content
                grep -v "^#" "$branch_secrets" | grep -v "^[[:space:]]*$" >> "$OUTPUT_FILE" || true
                count=$(grep -c "^\[secret\]" "$branch_secrets" 2>/dev/null || echo 0)
                secrets_count=$((secrets_count + count))
                echo "  → Grafted secrets from: $branch_name"
            fi
        fi
    done < "$BRANCHES_FILE"
fi

# Report results
if [ $secrets_count -eq 0 ]; then
    echo "  → No secrets found in any branch"
else
    echo "  → Grafted $secrets_count secret(s) from all branches"
fi

exit 0

