#!/bin/bash
# graft-mcp - Merge MCP servers from trunk and branches
# Part of Eden's pluggable grafter system
set -e

# Report covered paths for eden doctor
if [[ "${1:-}" == "--covers" ]]; then
    echo ".config/mcp"
    exit 0
fi

# Check if jq is installed
if ! command -v jq >/dev/null 2>&1; then
    echo "  ⚠ jq required for MCP graft (skipping)"
    exit 0
fi

# Detect Eden root from script location
if [[ -z "$EDEN_ROOT" ]]; then
    SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")"
    EDEN_ROOT="$(cd "$(dirname "$SCRIPT_PATH")/../../../../.." && pwd)"
fi

# Expand variables in branch path
expand_branch_path() {
    local path="$1"
    # Expand $EDEN_ROOT
    path="${path//\$EDEN_ROOT/$EDEN_ROOT}"
    # Expand tilde
    path="${path/#\~/$HOME}"
    echo "$path"
}

CANONICAL_CONFIG="$HOME/.config/mcp/servers.json"

# Initialize with empty config
MERGED_JSON='{"mcpServers": {}}'

echo "  → Merging MCP servers from branches"

# Merge branch configs if branches file exists
BRANCHES_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/eden/branches"
if [[ -f "$BRANCHES_FILE" ]]; then
    while IFS= read -r branch_path; do
        [[ -z "$branch_path" ]] && continue
        [[ "$branch_path" =~ ^[[:space:]]*# ]] && continue
        
        # Expand variables and tilde
        branch_path=$(expand_branch_path "$branch_path")
        
        branch_name=$(basename "$branch_path")
        
        # Canonical path (mirrors HOME directory)
        branch_config="$branch_path/.config/mcp/servers.json"
        
        # Legacy fallbacks for backwards compatibility
        if [[ ! -f "$branch_config" ]]; then
            branch_config="$branch_path/.cursor/mcp.json"
        fi
        if [[ ! -f "$branch_config" ]]; then
            branch_config="$branch_path/packages/common/.config/cursor/mcp_config.branch.json"
        fi
        
        if [[ -f "$branch_config" ]]; then
            echo "  → Merging MCP servers from: $branch_name"
            
            # Merge mcpServers from branch into merged config
            MERGED_JSON=$(echo "$MERGED_JSON" | jq --slurpfile branch "$branch_config" \
                '.mcpServers += $branch[0].mcpServers')
        fi
    done < "$BRANCHES_FILE"
fi

# Ensure canonical directory exists
mkdir -p "$(dirname "$CANONICAL_CONFIG")"

# Write merged config to canonical location
echo "$MERGED_JSON" | jq '.' > "$CANONICAL_CONFIG"

# Resolve bare command names to absolute paths.
# GUI clients (Claude Desktop, Cursor) don't inherit shell PATH, so bare
# commands like "mcp-foo" or "npx" won't be found. The graft runs from a
# terminal with the full PATH, so we resolve here at plant time.
resolve_commands() {
    local json="$1" server cmd full_path
    while IFS= read -r server; do
        cmd=$(printf '%s' "$json" | jq -r --arg s "$server" '.mcpServers[$s].command // empty')
        [[ -z "$cmd" || "$cmd" == /* ]] && continue
        full_path=$(command -v "$cmd" 2>/dev/null) || {
            echo "  ⚠ Cannot resolve command '$cmd' for server '$server'" >&2
            continue
        }
        json=$(printf '%s' "$json" | jq --arg s "$server" --arg p "$full_path" \
            '.mcpServers[$s].command = $p')
    done < <(printf '%s' "$json" | jq -r '.mcpServers | keys[]')
    printf '%s' "$json"
}

# Sync MCP servers into a client's config.
# Merges only .mcpServers — preserves other keys (app preferences, etc.).
sync_mcp_client() {
    local client_name="$1" client_config="$2"
    local client_dir
    client_dir="$(dirname "$client_config")"
    [[ -d "$client_dir" ]] || return 0

    # Resolve bare commands to absolute paths for GUI clients
    local resolved_json
    resolved_json=$(resolve_commands "$(cat "$CANONICAL_CONFIG")")

    # No config yet — just write resolved config
    if [[ ! -f "$client_config" ]]; then
        printf '%s' "$resolved_json" | jq '.' > "$client_config"
        echo "  → Synced $client_name"
        return 0
    fi

    # Merge Eden's mcpServers into the client config, preserving other keys
    local merged
    merged=$(jq -S --argjson eden "$resolved_json" \
        '.mcpServers = $eden.mcpServers' "$client_config")

    # Already in sync — nothing to do
    if diff -q <(echo "$merged") <(jq -S . "$client_config") &>/dev/null; then
        echo "  → $client_name in sync"
        return 0
    fi

    # Differs — prompt with optional diff
    echo "  ⚠ $client_name MCP servers differ from Eden"
    if [[ -t 0 ]]; then
        while true; do
            echo -n "    [p]lant Eden servers, [s]kip, [d]iff? "
            read -r choice
            case "$choice" in
                p|P)
                    echo "$merged" | jq . > "$client_config"
                    echo "  → Planted Eden MCP servers to $client_name"
                    break ;;
                s|S)
                    echo "  → Skipped $client_name"
                    break ;;
                d|D)
                    diff -u --label "after (eden merged)" --label "current ($client_name)" \
                        <(echo "$merged") <(jq -S . "$client_config") \
                        | if command -v delta &>/dev/null; then delta
                          elif command -v colordiff &>/dev/null; then colordiff
                          else cat; fi || true
                    ;;
                *) echo "    Please enter p, s, or d" ;;
            esac
        done
    else
        echo "    Skipped (run interactively to resolve)"
    fi
}

# Sync MCP servers into Claude Code's ~/.claude.json.
# Union merge: preserves user-added global servers, Eden servers win on conflicts.
sync_claude_code() {
    local client_config="$HOME/.claude.json"
    [[ -f "$client_config" ]] || return 0

    local merged
    merged=$(jq -S --slurpfile eden "$CANONICAL_CONFIG" \
        '.mcpServers = ((.mcpServers // {}) + $eden[0].mcpServers)' "$client_config")

    if diff -q <(echo "$merged") <(jq -S . "$client_config") &>/dev/null; then
        echo "  → Claude Code in sync"
        return 0
    fi

    echo "$merged" | jq . > "$client_config"
    echo "  → Synced Claude Code"
}

# Sync to MCP clients
sync_mcp_client "Cursor" "$HOME/.cursor/mcp.json"
if [[ "$(uname)" == "Darwin" ]]; then
    sync_mcp_client "Claude Desktop" "$HOME/Library/Application Support/Claude/claude_desktop_config.json"
fi
sync_claude_code

# Show summary
SERVER_COUNT=$(echo "$MERGED_JSON" | jq '.mcpServers | length')
echo "  → Configured $SERVER_COUNT MCP server(s)"

exit 0

