#!/usr/bin/env bash
# Show differences between current system and Eden config
# Usage: eden os diff

set -uo pipefail

# Determine Eden root directory
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
EDEN_ROOT="$(cd "$SCRIPT_DIR/../../../.." && pwd)"

CONFIG_DIR="$EDEN_ROOT/packages/mac/.config/macos"
MACOS_VERSION=$(sw_vers -productVersion | cut -d. -f1)
CONFIG_FILE="$CONFIG_DIR/defaults-${MACOS_VERSION}.sh"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
GRAY='\033[0;90m'
RESET='\033[0m'

echo -e "${BOLD}Comparing current macOS defaults with Eden configuration...${RESET}\n"

# Check if config exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}Config not found: $CONFIG_FILE${RESET}"
    echo ""
    echo "Create one with:"
    echo "  eden os dump    # Generate reference"
    echo "  eden os edit    # Create config"
    exit 1
fi

# Parse defaults write commands from config and compare
changes=0

while IFS= read -r line; do
    # Skip comments and empty lines
    [[ "$line" =~ ^[[:space:]]*# ]] && continue
    [[ -z "$line" ]] && continue
    
    # Match: defaults write "domain" "key" -type value
    if [[ "$line" =~ defaults[[:space:]]+write[[:space:]]+\"([^\"]+)\"[[:space:]]+\"([^\"]+)\"[[:space:]]+-([a-z]+)[[:space:]]+(.+) ]]; then
        domain="${BASH_REMATCH[1]}"
        key="${BASH_REMATCH[2]}"
        type="${BASH_REMATCH[3]}"
        desired="${BASH_REMATCH[4]}"
        
        # Clean up desired value (remove trailing stuff like "||" and quotes)
        desired=$(echo "$desired" | sed 's/ 2>.*//' | sed 's/ ||.*//' | tr -d '"')
        
        # Get current value
        current=$(defaults read "$domain" "$key" 2>/dev/null || echo "")
        
        # Compare based on type
        case "$type" in
            bool)
                # Normalize bool
                [[ "$current" == "1" ]] && current="true"
                [[ "$current" == "0" ]] && current="false"
                [[ "$desired" == "1" ]] && desired="true"
                [[ "$desired" == "0" ]] && desired="false"
                ;;
        esac
        
        # Check if different
        if [ "$current" != "$desired" ]; then
            echo -e "${YELLOW}$key${RESET}: ${RED}$current${RESET} → ${GREEN}$desired${RESET}"
            ((changes++))
        fi
    fi
done < "$CONFIG_FILE"

echo ""

if [ $changes -eq 0 ]; then
    echo -e "${GREEN}✓${RESET} No differences - your system matches Eden config"
else
    echo -e "${YELLOW}$changes${RESET} setting(s) would change"
    echo ""
    echo "To apply: ${BOLD}eden os apply${RESET}"
fi

echo ""
