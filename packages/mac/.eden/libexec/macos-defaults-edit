#!/usr/bin/env bash
# Edit macOS defaults configuration
# Usage: eden os edit

set -euo pipefail

# Determine Eden root directory
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
EDEN_ROOT="$(cd "$SCRIPT_DIR/../../../.." && pwd)"

CONFIG_DIR="$EDEN_ROOT/packages/mac/.config/macos"
MACOS_VERSION=$(sw_vers -productVersion | cut -d. -f1)
CONFIG_FILE="$CONFIG_DIR/defaults-${MACOS_VERSION}.sh"
DUMP_FILE="$CONFIG_DIR/defaults-${MACOS_VERSION}-dump.sh"

# Color codes
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
GRAY='\033[0;90m'
BOLD='\033[1m'
RESET='\033[0m'

print_header() {
    echo -e "${BOLD}${BLUE}$1${RESET}"
}

print_info() {
    echo -e "${BLUE}→${RESET} $1"
}

print_success() {
    echo -e "${GREEN}✓${RESET} $1"
}

# Check if config exists, create template if not
if [ ! -f "$CONFIG_FILE" ]; then
    print_header "Creating new config"
    echo ""
    
    # Create template
    cat > "$CONFIG_FILE" << EOF
#!/usr/bin/env bash
# macOS Defaults Configuration
# 
# Generated: $(date '+%Y-%m-%d %H:%M:%S')
# macOS Version: $MACOS_VERSION
#
# WORKFLOW:
#   1. Browse the reference: defaults-${MACOS_VERSION}-dump.sh
#   2. Copy settings you want here
#   3. Uncomment the defaults write commands
#   4. Apply: eden os load

set -euo pipefail

echo "Applying macOS defaults..."
echo ""

# ============================================================================
# Your Custom Settings
# ============================================================================

# Copy settings from defaults-${MACOS_VERSION}-dump.sh and uncomment:

# Example:
# defaults write com.apple.dock autohide -bool true
# defaults write NSGlobalDomain KeyRepeat -int 2


# ============================================================================
# Restart Applications
# ============================================================================

echo ""
echo "Restarting affected applications..."
killall Finder 2>/dev/null || true
killall Dock 2>/dev/null || true
killall SystemUIServer 2>/dev/null || true
killall cfprefsd 2>/dev/null || true

echo ""
echo "✓ macOS defaults applied successfully!"
echo ""
EOF
    
    chmod +x "$CONFIG_FILE"
    print_success "Created: ${GRAY}$CONFIG_FILE${RESET}"
    echo ""
fi

# Check if dump exists
if [ ! -f "$DUMP_FILE" ]; then
    print_info "Reference dump not found. Generate it first:"
    echo -e "  ${BOLD}eden os dump${RESET}"
    echo ""
fi

# Detect editor
EDITOR_CMD="${EDITOR:-vim}"

# Open in editor
print_info "Opening config in $EDITOR_CMD..."
echo ""
exec "$EDITOR_CMD" "$CONFIG_FILE"

