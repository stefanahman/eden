#!/usr/bin/env bash
# eden - Central command dispatcher for Eden environment management
# Usage: eden <command> [options]

set -euo pipefail

# Determine Eden root directory
# This script lives in packages/common/.local/bin/, so go up 4 levels
# Resolve symlinks first to find the actual script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
# Follow symlinks to get the real path
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    # If the symlink is relative, make it absolute
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
# bin/eden is one level deep from repo root
EDEN_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
RESET='\033[0m'

# Print colored output
print_header() {
    echo -e "${BOLD}${BLUE}$1${RESET}"
}

print_success() {
    echo -e "${GREEN}✓${RESET} $1"
}

print_error() {
    echo -e "${RED}✗${RESET} $1" >&2
}

print_info() {
    echo -e "${BLUE}→${RESET} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${RESET} $1"
}

# Show help
show_help() {
    print_header "Eden - Personal Environment Manager"
    echo ""
    echo -e "${BOLD}Usage:${RESET}"
    echo "  eden <command> [options]"
    echo ""
    echo -e "${BOLD}Core Commands:${RESET}"
    echo "  install [package]     Install packages (no args = all from Brewfile/pacman.txt)"
    echo "                        Specific packages: gcloud | Use --list to see all"
    echo "  update                Update Eden from git and re-apply symlinks"
    echo "  stow [--adopt]        Apply Eden symlinks (common + platform packages)"
    echo "                        Use --adopt to pull existing files into Eden"
    echo "  unstow                Remove Eden symlinks (temporary, keeps ~/.eden/)"
    echo "  uninstall             Complete Eden removal (unstow + remove ~/.eden/)"
    echo "  graft                 Discover and integrate branch configs"
    echo "  doctor                Validate Eden installation health"
    echo "  status                Show Eden system overview and health"
    echo ""
    echo -e "${BOLD}Package Management:${RESET}"
    echo "  install --list        List all available packages to install"
    echo "  check-package <name>  Check if a package exists (official repo, AUR, or brew)"
    echo "  list-packages         Show platform packages (Brewfile/pacman.txt)"
    echo "  packages              [deprecated] Use 'eden install' instead"
    echo ""
    echo -e "${BOLD}Platform Commands:${RESET}"
    echo "  deploy-arch           Deploy common + arch packages only"
    echo "  deploy-mac            Deploy common + mac packages only"
    echo ""
    echo -e "${BOLD}Utility Commands:${RESET}"
    echo "  eden-secrets          Manage 1Password secrets"
    echo "  eden-mcp-merge        Merge MCP configuration files"
    echo "  version               Show Eden version and location"
    echo "  help                  Show this help message"
    echo ""
    echo -e "${BOLD}Examples:${RESET}"
    echo "  eden install          # Install all platform packages"
    echo "  eden install gcloud   # Install Google Cloud CLI"
    echo "  eden install --list   # See all available packages"
    echo "  eden update           # Update to latest Eden changes"
    echo "  eden stow --adopt     # Pull existing configs into Eden"
    echo "  eden graft            # Integrate branch configurations"
    echo "  eden doctor           # Check system health"
    echo "  eden check-package fnm  # Check where a package is available"
    echo ""
    echo -e "${BOLD}Environment:${RESET}"
    echo "  Eden Root: $EDEN_ROOT"
    echo ""
    echo "For more information, see the README at $EDEN_ROOT/README.md"
}

# Show version
show_version() {
    print_header "Eden Environment Manager"
    echo "Location: $EDEN_ROOT"
    
    if [ -d "$EDEN_ROOT/.git" ]; then
        local commit=$(cd "$EDEN_ROOT" && git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        local branch=$(cd "$EDEN_ROOT" && git branch --show-current 2>/dev/null || echo "unknown")
        echo "Branch: $branch"
        echo "Commit: $commit"
    fi
}

# Install packages based on platform
install_packages() {
    print_header "Installing Platform Packages"
    
    case "$(uname -s)" in
        Darwin)
            print_info "macOS detected - installing from Brewfile"
            if ! command -v brew &> /dev/null; then
                print_error "Homebrew not found. Please install Homebrew first."
                exit 1
            fi
            cd "$EDEN_ROOT"
            if [ -f "Brewfile" ]; then
                brew bundle
                print_success "Packages installed from Brewfile"
            else
                print_error "Brewfile not found"
                exit 1
            fi
            ;;
        Linux)
            print_info "Linux detected - installing from pacman.txt"
            cd "$EDEN_ROOT"
            if [ -f "pacman.txt" ]; then
                # Filter out comments and empty lines
                local packages=$(grep -v '^#' pacman.txt | grep -v '^$' | tr '\n' ' ')
                
                # Check for yay (AUR helper) first
                if command -v yay &> /dev/null; then
                    print_info "Using yay (includes AUR packages)"
                    yay -S --needed $packages
                    print_success "Packages installed from pacman.txt"
                elif command -v pacman &> /dev/null; then
                    print_info "Using pacman (AUR packages will be skipped)"
                    print_info "For AUR packages, install yay first"
                    sudo pacman -S --needed $packages 2>&1 || true
                    echo ""
                    print_info "Install yay: git clone https://aur.archlinux.org/yay.git && cd yay && makepkg -si"
                else
                    print_error "Neither yay nor pacman found. Are you on Arch Linux?"
                    exit 1
                fi
            else
                print_error "pacman.txt not found"
                exit 1
            fi
            ;;
        *)
            print_error "Unsupported platform: $(uname -s)"
            exit 1
            ;;
    esac
}

# List available packages
list_packages() {
    print_header "Available Packages for Current Platform"
    
    case "$(uname -s)" in
        Darwin)
            echo "Platform: macOS (Homebrew)"
            echo "Package file: $EDEN_ROOT/Brewfile"
            echo ""
            if [ -f "$EDEN_ROOT/Brewfile" ]; then
                cat "$EDEN_ROOT/Brewfile"
            fi
            ;;
        Linux)
            echo "Platform: Arch Linux (pacman)"
            echo "Package file: $EDEN_ROOT/pacman.txt"
            echo ""
            if [ -f "$EDEN_ROOT/pacman.txt" ]; then
                cat "$EDEN_ROOT/pacman.txt"
            fi
            ;;
        *)
            print_error "Unsupported platform: $(uname -s)"
            exit 1
            ;;
    esac
}

# Check if a package exists and where
check_package() {
    local pkg="$1"
    
    if [ -z "$pkg" ]; then
        print_error "Usage: eden check-package <package-name>"
        exit 1
    fi
    
    print_header "Checking package: $pkg"
    echo ""
    
    case "$(uname -s)" in
        Darwin)
            print_info "Platform: macOS (Homebrew)"
            echo ""
            
            if ! command -v brew &> /dev/null; then
                print_error "Homebrew not installed"
                exit 1
            fi
            
            # Search brew
            echo "Searching Homebrew..."
            if brew search "$pkg" 2>/dev/null | grep -q "^$pkg\$"; then
                print_success "Found in Homebrew formulae: $pkg"
                echo ""
                brew info "$pkg" 2>/dev/null | head -5
            elif brew search --cask "$pkg" 2>/dev/null | grep -q "^$pkg\$"; then
                print_success "Found in Homebrew casks: $pkg"
                echo ""
                brew info --cask "$pkg" 2>/dev/null | head -5
            else
                echo "Searching for similar packages:"
                brew search "$pkg" 2>/dev/null | head -10
            fi
            ;;
        Linux)
            print_info "Platform: Arch Linux"
            echo ""
            
            # Check priority: Omarchy -> Official repos -> AUR
            
            # 1. Check Omarchy repo first
            if pacman -Ss "^$pkg$" 2>/dev/null | grep -q "^omarchy/"; then
                print_success "Found in Omarchy repo: $pkg"
                echo ""
                pacman -Si "$pkg" 2>/dev/null | grep -E "^(Repository|Name|Version|Description)" || true
            # 2. Check official repos
            elif pacman -Ss "^$pkg$" 2>/dev/null | grep -q "^"; then
                print_success "Found in official repos: $pkg"
                echo ""
                pacman -Si "$pkg" 2>/dev/null | grep -E "^(Repository|Name|Version|Description)" || true
            # 3. Check AUR if yay is available
            elif command -v yay &> /dev/null; then
                echo "Not in Omarchy or official repos, checking AUR..."
                if yay -Ss "^$pkg$" 2>/dev/null | grep -q "^aur/$pkg"; then
                    print_success "Found in AUR: $pkg"
                    echo ""
                    yay -Si "$pkg" 2>/dev/null | grep -E "^(Repository|Name|Version|Description)" || true
                else
                    print_error "Package not found in Omarchy, official repos, or AUR"
                    echo ""
                    echo "Searching for similar packages:"
                    echo ""
                    echo "Omarchy repo:"
                    pacman -Sl omarchy 2>/dev/null | grep "$pkg" | head -10 || echo "  (none found)"
                    echo ""
                    echo "Official repos:"
                    pacman -Ss "$pkg" 2>/dev/null | head -10 || echo "  (none found)"
                    echo ""
                    echo "AUR:"
                    yay -Ss "$pkg" 2>/dev/null | grep "^aur/" | head -10 || echo "  (none found)"
                fi
            else
                print_error "Package not found in Omarchy or official repos"
                echo ""
                echo "Install yay to check AUR: git clone https://aur.archlinux.org/yay.git && cd yay && makepkg -si"
                echo ""
                echo "Searching for similar packages:"
                echo ""
                echo "Omarchy repo:"
                pacman -Sl omarchy 2>/dev/null | grep "$pkg" | head -10 || echo "  (none found)"
                echo ""
                echo "Official repos:"
                pacman -Ss "$pkg" 2>/dev/null | head -10 || echo "  (none found)"
            fi
            ;;
        *)
            print_error "Unsupported platform: $(uname -s)"
            exit 1
            ;;
    esac
}

# Run a script from Eden root
run_script() {
    local script_name="$1"
    shift
    
    # Scripts are now in bin/ directory
    local script_path="$EDEN_ROOT/bin/$script_name"
    
    # For install.sh, check root directory
    if [ "$script_name" = "install.sh" ]; then
        script_path="$EDEN_ROOT/install.sh"
    fi
    
    if [ ! -f "$script_path" ]; then
        print_error "Script not found: $script_path"
        exit 1
    fi
    
    if [ ! -x "$script_path" ]; then
        print_error "Script not executable: $script_path"
        exit 1
    fi
    
    cd "$EDEN_ROOT"
    "$script_path" "$@"
}

# Deploy platform-specific packages
deploy_platform() {
    local platform="$1"
    print_header "Deploying Eden for $platform"
    
    cd "$EDEN_ROOT"
    
    # Stow packages in order
    print_info "Stowing common package..."
    stow -v -d packages -t "$HOME" common
    
    print_info "Stowing eden package..."
    stow -v -d packages -t "$HOME" eden
    
    print_info "Stowing $platform package..."
    stow -v -d packages -t "$HOME" "$platform"
    
    print_success "Deployment complete"
}

# Main command dispatcher
main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    local command="$1"
    shift
    
    case "$command" in
        install)
            # Unified install interface
            case "${1:-all}" in
                all|--all|"")
                    install_packages
                    ;;
                --list)
                    print_header "Available Packages"
                    echo ""
                    echo "Platform packages (from Brewfile/pacman.txt):"
                    echo "  eden install        # Install all platform packages"
                    echo ""
                    echo "Additional tools:"
                    
                    # Auto-discover packages from libexec
                    LIBEXEC_DIR="$HOME/.eden/libexec"
                    if [ ! -d "$LIBEXEC_DIR" ]; then
                        LIBEXEC_DIR="$EDEN_ROOT/packages/eden/.eden/libexec"
                    fi
                    
                    if [ -d "$LIBEXEC_DIR" ]; then
                        for script in "$LIBEXEC_DIR"/*; do
                            if [ -f "$script" ] && [ -x "$script" ]; then
                                local pkg_name=$(basename "$script" | sed 's/-setup$//')
                                # Try to extract description from script (first line with # comment after shebang)
                                local desc=$(grep -m 1 "^# " "$script" | sed 's/^# //' | head -1)
                                [ -z "$desc" ] && desc="Install/configure $pkg_name"
                                printf "  %-18s # %s\n" "$pkg_name" "$desc"
                            fi
                        done
                    else
                        echo "  (libexec not found - run 'eden stow' first)"
                    fi
                    
                    echo ""
                    echo "Usage: eden install <package>"
                    ;;
                *)
                    # Auto-discover and run package installer from libexec
                    local pkg_name="$1"
                    shift
                    
                    LIBEXEC_DIR="$HOME/.eden/libexec"
                    if [ ! -d "$LIBEXEC_DIR" ]; then
                        LIBEXEC_DIR="$EDEN_ROOT/packages/eden/.eden/libexec"
                    fi
                    
                    # Try both with and without -setup suffix
                    local installer=""
                    for candidate in "$LIBEXEC_DIR/$pkg_name" "$LIBEXEC_DIR/${pkg_name}-setup"; do
                        if [ -f "$candidate" ] && [ -x "$candidate" ]; then
                            installer="$candidate"
                            break
                        fi
                    done
                    
                    if [ -n "$installer" ]; then
                        "$installer" "$@"
                    else
                        print_error "Unknown package: $pkg_name"
                        echo "Run 'eden install --list' to see available packages"
                        exit 1
                    fi
                    ;;
            esac
            ;;
        update)
            run_script "eden-update" "$@"
            ;;
        stow)
            # Check for --adopt flag
            ADOPT_FLAG=""
            if [[ "$*" == *"--adopt"* ]]; then
                ADOPT_FLAG="--adopt"
                print_header "Adopting and Stowing Eden Configs"
                echo ""
                print_info "This will move existing files into Eden and create symlinks"
                echo ""
            else
                print_header "Applying Eden Symlinks"
            fi
            
            cd "$EDEN_ROOT"
            case "$(uname -s)" in
                Darwin)
                    print_info "Stowing common + eden + mac packages..."
                    stow -v $ADOPT_FLAG -d packages -t "$HOME" common eden mac
                    ;;
                Linux)
                    print_info "Stowing common + eden + arch packages..."
                    stow -v $ADOPT_FLAG -d packages -t "$HOME" common eden arch
                    ;;
            esac
            
            if [[ -n "$ADOPT_FLAG" ]]; then
                print_success "Files adopted into Eden and symlinks created"
                echo ""
                print_info "Next steps:"
                echo "  1. Review changes: cd $EDEN_ROOT && git status"
                echo "  2. Check diffs: git diff"
                echo "  3. Commit if satisfied: git add -A && git commit -m 'Adopt configs from Omarchy'"
                echo "  4. Or revert: git checkout ."
            else
                print_success "Eden symlinks applied"
            fi
            ;;
        unstow|clean)
            print_header "Removing Eden Symlinks"
            cd "$EDEN_ROOT"
            case "$(uname -s)" in
                Darwin)
                    stow -D -d packages -t "$HOME" common eden mac 2>/dev/null || true
                    ;;
                Linux)
                    stow -D -d packages -t "$HOME" common eden arch 2>/dev/null || true
                    ;;
            esac
            
            # Clean up ~/.eden/ if it's empty or only contains empty directories
            if [ -d "$HOME/.eden" ]; then
                # Remove empty subdirectories
                find "$HOME/.eden" -type d -empty -delete 2>/dev/null || true
                # Remove ~/.eden if now empty
                rmdir "$HOME/.eden" 2>/dev/null || true
            fi
            
            print_success "Eden symlinks removed"
            [ -d "$HOME/.eden" ] && print_info "~/.eden/ preserved (contains branch configs/binaries)"
            ;;
        uninstall)
            print_header "Uninstalling Eden"
            echo ""
            print_warning "This will completely remove Eden from your system:"
            echo "  • Remove all Eden symlinks"
            echo "  • Delete ~/.eden/ directory (grafted binaries, configs)"
            echo "  • Remove root eden wrapper script"
            echo ""
            echo -n "Are you sure? [y/N] "
            read -r response
            if [[ ! "$response" =~ ^[Yy]$ ]]; then
                echo "Uninstall cancelled"
                exit 0
            fi
            
            echo ""
            print_info "Removing Eden symlinks..."
            cd "$EDEN_ROOT"
            case "$(uname -s)" in
                Darwin)
                    stow -D -d packages -t "$HOME" common eden mac 2>/dev/null || true
                    ;;
                Linux)
                    stow -D -d packages -t "$HOME" common eden arch 2>/dev/null || true
                    ;;
            esac
            
            print_info "Removing ~/.eden/ directory..."
            rm -rf "$HOME/.eden"
            
            print_info "Removing eden wrapper from ~/.local/bin/..."
            rm -f "$HOME/.local/bin/eden"
            
            echo ""
            print_success "Eden uninstalled successfully"
            echo ""
            print_info "Note: Shell config PATH entries remain but are harmless"
            echo "  To fully clean up, remove Eden PATH entries from:"
            echo "  • ~/.config/zsh/.zshenv"
            echo "  • ~/.config/bash/profile"
            ;;
        graft)
            run_script "eden-graft" "$@"
            ;;
        doctor)
            run_script "eden-doctor" "$@"
            ;;
        status|info)
            # Check if eden-status exists, otherwise show basic info
            if [ -f "$EDEN_ROOT/bin/eden-status" ]; then
                run_script "eden-status" "$@"
            else
                show_version
                echo ""
                run_script "eden-doctor" "$@"
            fi
            ;;
        packages)
            print_warning "'eden packages' is deprecated, use 'eden install' instead"
            install_packages
            ;;
        list-packages)
            list_packages
            ;;
        check-package)
            check_package "$@"
            ;;
        deploy-arch)
            deploy_platform "arch"
            ;;
        deploy-mac)
            deploy_platform "mac"
            ;;
        version|--version|-v)
            show_version
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "Unknown command: $command"
            echo ""
            echo "Run 'eden help' for usage information."
            exit 1
            ;;
    esac
}

main "$@"

