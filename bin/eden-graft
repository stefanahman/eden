#!/bin/bash
# Eden graft - Graft branch configs into Eden
# Auto-discovers configs from branch repos and grafts them into local configs
set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "${GREEN}â–¸${NC} $1"
}

warn() {
    echo -e "${YELLOW}âš ${NC} $1"
}

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

BRANCHES_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/eden/branches"

# Check if branches file exists
if [ ! -f "$BRANCHES_FILE" ]; then
    warn "No branches file found at $BRANCHES_FILE"
    echo "  Run ./install.sh first"
    exit 1
fi


# =============================================================================
# PLUGGABLE GRAFTER SYSTEM
# =============================================================================
run_pluggable_grafters() {
    local grafters_dir="$HOME/.eden/libexec/grafters"
    
    # Fall back to repo location if not stowed yet
    if [ ! -d "$grafters_dir" ]; then
        grafters_dir="$SCRIPT_DIR/../packages/eden/.eden/libexec/grafters"
    fi
    
    if [ ! -d "$grafters_dir" ]; then
        warn "Grafters directory not found. Run 'eden plant' first."
        return 1
    fi
    
    log "Running pluggable grafters..."
    echo ""
    
    # Discover and run all grafters
    local grafter_count=0
    for grafter in "$grafters_dir"/graft-*; do
        [ -e "$grafter" ] || continue
        [ -x "$grafter" ] || continue
        
        local grafter_name=$(basename "$grafter")
        log "Running: $grafter_name"
        
        # Source the grafter (allows it to use return 0)
        if bash "$grafter"; then
            grafter_count=$((grafter_count + 1))
        else
            warn "$grafter_name failed (exit code: $?)"
        fi
        echo ""
    done
    
    if [ $grafter_count -eq 0 ]; then
        warn "No grafters found in $grafters_dir"
        return 1
    fi
    
    return 0
}

# =============================================================================
# MAIN
# =============================================================================
main() {
    log "Grafting branch configs into Eden..."
    echo ""
    
    # Run all pluggable grafters
    if run_pluggable_grafters; then
        echo ""
        log "Graft complete! ðŸŒ³"
    else
        echo ""
        warn "Graft completed with errors"
        exit 1
    fi
}

main "$@"
