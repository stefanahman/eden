#!/bin/bash
# Eden doctor - Health check and validation
set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

ERRORS=0

check_pass() {
    echo -e "  ${GREEN}✓${NC} $1"
}

check_fail() {
    echo -e "  ${RED}✗${NC} $1"
    ((ERRORS++))
}

check_warn() {
    echo -e "  ${YELLOW}⚠${NC} $1"
}

section() {
    echo ""
    echo "$1"
}

# Get Eden directory (parent of bin/)
EDEN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

section "Eden Health Check"
section "=================="

# Check dependencies
section "Dependencies:"

if command -v git >/dev/null 2>&1; then
    GIT_VER=$(git --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
    check_pass "git installed ($GIT_VER)"
else
    check_fail "git not found"
fi

if command -v stow >/dev/null 2>&1; then
    STOW_VER=$(stow --version | head -1 | grep -oE '[0-9]+\.[0-9]+' | head -1)
    if awk -v ver="$STOW_VER" 'BEGIN { exit (ver < 2.3) }'; then
        check_pass "stow installed ($STOW_VER)"
    else
        check_warn "stow $STOW_VER (recommend >= 2.3.0)"
    fi
else
    check_fail "stow not found"
fi

# Check repository
section "Repository:"

cd "$EDEN_DIR" || check_fail "Cannot access Eden directory"

if [ -d "$EDEN_DIR/.git" ]; then
    check_pass "Eden git repository exists"
    
    if git diff-index --quiet HEAD -- 2>/dev/null; then
        check_pass "Repository is clean (no uncommitted changes)"
    else
        check_warn "Repository has uncommitted changes"
    fi
else
    check_fail "Not a git repository"
fi

# Check Eden directories and binaries
section "Eden Structure:"

# Check smart wrapper
if [ -f "$HOME/.local/bin/eden" ] && [ ! -L "$HOME/.local/bin/eden" ]; then
    check_pass "Eden wrapper installed at ~/.local/bin/eden"
else
    if [ -L "$HOME/.local/bin/eden" ]; then
        check_warn "Eden wrapper is a symlink (should be copied file)"
    else
        check_fail "Eden wrapper not found at ~/.local/bin/eden"
    fi
fi

# Check main implementation
if [ -f "$EDEN_DIR/bin/eden" ]; then
    check_pass "Eden CLI implementation at bin/eden"
else
    check_fail "Eden CLI missing at bin/eden"
fi

# Check ~/.eden structure
if [ -d "$HOME/.eden" ]; then
    check_pass "~/.eden directory exists"
    
    if [ -d "$HOME/.eden/libexec" ]; then
        LIBEXEC_COUNT=$(find "$HOME/.eden/libexec" -type f 2>/dev/null | wc -l)
        check_pass "~/.eden/libexec exists ($LIBEXEC_COUNT internal utilities)"
    else
        check_warn "~/.eden/libexec not found (may not be stowed yet)"
    fi
    
    if [ -d "$HOME/.eden/bin" ]; then
        BIN_COUNT=$(find "$HOME/.eden/bin" -type l 2>/dev/null | wc -l)
        check_pass "~/.eden/bin exists ($BIN_COUNT grafted binaries)"
    else
        check_warn "~/.eden/bin not found (no branch binaries grafted)"
    fi
    
    if [ -f "$HOME/.eden/config/branches" ]; then
        check_pass "Branch tracking file exists"
    else
        check_warn "No branch tracking file (run 'eden graft' to set up)"
    fi
else
    check_warn "~/.eden directory not found (may not be stowed yet)"
fi

# Check symlinks
section "Symlinks:"

BROKEN=0
if command -v find >/dev/null 2>&1; then
    # Check for broken symlinks in common Eden locations
    for dir in "$HOME/.config" "$HOME/.local/bin"; do
        if [ -d "$dir" ]; then
            while IFS= read -r -d '' link; do
                if [ ! -e "$link" ]; then
                    check_warn "Broken symlink: $link"
                    ((BROKEN++))
                fi
            done < <(find "$dir" -maxdepth 2 -type l -print0 2>/dev/null)
        fi
    done
    
    if [ $BROKEN -eq 0 ]; then
        check_pass "No broken symlinks found"
    fi
else
    check_warn "find command not available, skipping symlink check"
fi

# Check macOS services (yabai, skhd)
if [ "$(uname -s)" = "Darwin" ]; then
    section "Services:"

    for svc in yabai skhd; do
        if command -v "$svc" >/dev/null 2>&1; then
            if pgrep -x "$svc" >/dev/null 2>&1; then
                check_pass "$svc running"
            else
                check_warn "$svc installed but not running ($svc --start-service)"
            fi
        fi
    done

    if [ -d "/Applications/Karabiner-Elements.app" ]; then
        if pgrep -f "karabiner_" >/dev/null 2>&1; then
            check_pass "Karabiner running"
        else
            check_warn "Karabiner installed but not running"
        fi
    fi
fi

# Check package counts
section "Package Statistics:"

COMMON_COUNT=$(find "$EDEN_DIR/packages/common" -type f 2>/dev/null | wc -l)
EDEN_COUNT=$(find "$EDEN_DIR/packages/eden" -type f 2>/dev/null | wc -l)
ARCH_COUNT=$(find "$EDEN_DIR/packages/arch" -type f 2>/dev/null | wc -l)
MAC_COUNT=$(find "$EDEN_DIR/packages/mac" -type f 2>/dev/null | wc -l)

echo "  Files: $COMMON_COUNT in common, $EDEN_COUNT in eden, $ARCH_COUNT in arch, $MAC_COUNT in mac"

# Platform parity check
section "Platform Parity:"

# Check for duplicate paths between common and platform packages
OS=""
case "$(uname -s)" in
    Linux*) OS="arch" ;;
    Darwin*) OS="mac" ;;
esac

if [ -n "$OS" ]; then
    DUPLICATES=0
    while IFS= read -r file; do
        REL_PATH="${file#$EDEN_DIR/packages/common/}"
        if [ -f "$EDEN_DIR/packages/$OS/$REL_PATH" ]; then
            check_warn "Duplicate: $REL_PATH (in both common and $OS)"
            ((DUPLICATES++))
        fi
    done < <(find "$EDEN_DIR/packages/common" -type f 2>/dev/null)
    
    if [ $DUPLICATES -eq 0 ]; then
        check_pass "No duplicate files between common and $OS packages"
    fi
fi

# Final result
section ""
if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}✓ Eden is healthy!${NC}"
    exit 0
else
    echo -e "${RED}✗ Found $ERRORS issue(s)${NC}"
    exit 1
fi

